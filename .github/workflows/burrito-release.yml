name: Build Burrito Release Assets

on:
  release:
    types: [published]

permissions:
  contents: write

concurrency:
  group: burrito-release-${{ github.event.release.tag_name }}
  cancel-in-progress: false

jobs:
  build-and-attach:
    name: Build Burrito and Upload Assets
    runs-on: ubuntu-latest
    env:
      MIX_ENV: prod

    steps:
      - name: Checkout release ref
        uses: actions/checkout@v6.0.2
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Set up BEAM
        uses: erlef/setup-beam@v1.20.4
        with:
          version-type: strict
          otp-version: "28.3.1"
          elixir-version: "1.19.5"

      - name: Set up Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: "25.6.1"
          cache: npm
          cache-dependency-path: assets/package-lock.json

      - name: Set up Zig
        uses: mlugg/setup-zig@v2.2.1
        with:
          version: "0.15.2"

      - name: Install Burrito system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends xz-utils p7zip-full

      - name: Install Elixir dependencies
        run: |
          mix local.hex --force
          mix local.rebar --force
          mix deps.get

      - name: Install frontend dependencies
        run: npm ci --prefix assets

      - name: Install asset toolchains
        run: mix assets.setup

      - name: Build release with Burrito
        run: mix release whisperlogs

      - name: Upload Burrito assets to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload "${{ github.event.release.tag_name }}" burrito_out/* --clobber
